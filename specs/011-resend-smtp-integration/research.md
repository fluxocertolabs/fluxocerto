# Research: Resend SMTP Integration for Production Email Delivery

**Feature Branch**: `011-resend-smtp-integration`  
**Date**: 2025-11-27  
**Status**: Complete

## Research Tasks

### 1. Resend SMTP Configuration for Supabase

**Task**: Research how to configure Resend SMTP with Supabase Authentication.

**Decision**: Use Supabase Dashboard SMTP configuration with Resend SMTP credentials.

**Rationale**:
- Resend provides official documentation for Supabase SMTP integration
- Configuration is done entirely through Supabase Dashboard (Project Settings → Authentication → SMTP)
- No code changes required - purely configuration-based
- Resend SMTP works with any service that supports standard SMTP

**SMTP Configuration Values**:
| Setting | Value |
|---------|-------|
| Host | `smtp.resend.com` |
| Port | `465` (SSL/TLS) |
| Username | `resend` |
| Password | Resend API key |
| Sender Email | `noreply@financas.fflo.me` |

**Alternatives Considered**:
- **Resend API integration**: Rejected (requires code changes, SMTP is simpler)
- **SendGrid**: Rejected (Resend has simpler setup, better free tier for low volume)
- **Mailgun**: Rejected (more complex setup, overkill for family use)
- **AWS SES**: Rejected (complex IAM setup, not worth it for ~5 users)

**Source**: [Resend Supabase SMTP Documentation](https://resend.com/docs/send-with-supabase-smtp)

---

### 2. Resend Domain Verification (DNS Records)

**Task**: Research DNS records required to verify a custom domain with Resend.

**Decision**: Configure SPF, DKIM, and optionally DMARC records for `financas.fflo.me`.

**Rationale**:
- Domain verification is required to send emails from a custom domain
- SPF and DKIM are mandatory for domain verification
- DMARC is optional but recommended for improved deliverability
- Records are generated by Resend and must be added to DNS

**Required DNS Records**:

1. **SPF Record** (TXT):
   - Purpose: Authorizes Resend to send email on behalf of the domain
   - Type: TXT
   - Name: `@` or `financas.fflo.me`
   - Value: Provided by Resend (typically includes `include:_spf.resend.com`)

2. **DKIM Record** (TXT):
   - Purpose: Cryptographic signature to verify email authenticity
   - Type: TXT
   - Name: `resend._domainkey` (or similar, provided by Resend)
   - Value: Long DKIM key string (provided by Resend)

3. **DMARC Record** (Optional but recommended) (TXT):
   - Purpose: Specifies how to handle emails that fail SPF/DKIM
   - Type: TXT
   - Name: `_dmarc`
   - Value: `v=DMARC1; p=none; rua=mailto:admin@example.com` (start with `p=none` for monitoring)

**Verification Process**:
1. Add domain in Resend Dashboard
2. Resend generates DNS records
3. Add records to domain registrar/DNS provider
4. Click "Verify" in Resend Dashboard
5. Wait for DNS propagation (can take up to 48 hours, usually faster)

**Common Issues**:
- DNS provider auto-appending domain name (causing `resend._domainkey.financas.fflo.me.financas.fflo.me`)
- Truncated DKIM values (copy entire value)
- Extra quotes or spaces in record values
- Records added to wrong DNS location (if using multiple DNS providers)

**Alternatives Considered**:
- **Subdomain only**: Could use `mail.financas.fflo.me` but full domain is cleaner
- **Skip DMARC**: Acceptable for initial setup, add later for better deliverability

**Source**: [Resend Domain Verification](https://resend.com/docs/dashboard/domains/introduction), [Resend DMARC Guide](https://resend.com/docs/dashboard/domains/dmarc)

---

### 3. Resend API Key Management

**Task**: Research best practices for creating and managing Resend API keys.

**Decision**: Create a "Sending access" API key restricted to the `financas.fflo.me` domain.

**Rationale**:
- "Sending access" permission is sufficient for SMTP use (only needs to send emails)
- Domain restriction limits potential damage if key is compromised
- Key is stored only in Supabase Dashboard, never in code or repository

**API Key Best Practices**:
1. **Use environment variables** - Never hardcode API keys
2. **Never commit to version control** - Keep keys out of git
3. **Use minimal permissions** - "Sending access" instead of "Full access"
4. **Domain restriction** - Restrict to specific domain when possible
5. **Rotate regularly** - Consider rotating keys periodically
6. **Delete unused keys** - Remove keys not used in 30+ days

**Key Creation Steps**:
1. Go to Resend Dashboard → API Keys
2. Click "Create API Key"
3. Name: `supabase-family-finance-production` (descriptive name)
4. Permission: "Sending access"
5. Domain: `financas.fflo.me` (restrict to verified domain)
6. Copy key immediately (only shown once)
7. Store in Supabase Dashboard SMTP settings

**Alternatives Considered**:
- **Full access key**: Rejected (unnecessary permissions for SMTP use)
- **No domain restriction**: Rejected (reduces security if key leaks)

**Source**: [Resend API Key Best Practices](https://resend.com/docs/knowledge-base/how-to-handle-api-keys)

---

### 4. Supabase Dashboard SMTP Configuration

**Task**: Research how to configure custom SMTP in Supabase Dashboard.

**Decision**: Use Supabase Dashboard Authentication settings to configure Resend SMTP.

**Rationale**:
- Supabase provides built-in SMTP configuration in Dashboard
- No code changes or environment variables needed in the application
- Configuration is project-specific and secure
- Local development continues to use Inbucket (config.toml settings)

**Configuration Steps**:
1. Go to Supabase Dashboard → Project Settings → Authentication
2. Scroll to "SMTP Settings" section
3. Toggle "Enable Custom SMTP"
4. Enter configuration:
   - **Host**: `smtp.resend.com`
   - **Port**: `465`
   - **Username**: `resend`
   - **Password**: (paste Resend API key)
   - **Sender email**: `noreply@financas.fflo.me`
   - **Sender name**: `Family Finance`
5. Save changes

**Important Notes**:
- Dashboard SMTP settings only affect production (hosted Supabase)
- Local development uses `supabase/config.toml` which has Inbucket configured
- The `[auth.email.smtp]` section in config.toml is commented out (correct)
- No changes needed to config.toml for this feature

**Testing After Configuration**:
1. Request Magic Link in production
2. Check email arrives in real inbox
3. Verify sender shows `noreply@financas.fflo.me`
4. Click link and confirm authentication works

**Alternatives Considered**:
- **Environment variables in Vercel**: Would require code changes to read them
- **Supabase CLI config**: Only affects local development, not production

**Source**: [Supabase Custom SMTP Documentation](https://supabase.com/docs/guides/auth/auth-smtp)

---

### 5. Local Development Email Flow (Unchanged)

**Task**: Verify that local development email flow remains unchanged.

**Decision**: No changes needed - local development continues to use Inbucket.

**Rationale**:
- `supabase/config.toml` has Inbucket enabled (lines 93-101)
- Local Supabase instance uses config.toml, not Dashboard settings
- Inbucket captures all emails sent locally at `localhost:54324`
- No SMTP section is enabled in config.toml (lines 188-196 are commented out)

**Current Local Email Configuration** (from config.toml):
```toml
[inbucket]
enabled = true
port = 54324
```

**Verification**:
- Run `supabase start` locally
- Request Magic Link
- Check Inbucket at `http://localhost:54324`
- Email should appear there (not sent externally)

**Alternatives Considered**:
- **Configure local SMTP**: Rejected (unnecessary, Inbucket works perfectly)
- **Use Resend locally**: Rejected (wastes free tier quota, slower testing)

---

### 6. Resend Free Tier Limits

**Task**: Research Resend free tier limits and verify sufficiency for family use.

**Decision**: Resend free tier (3,000/month, 100/day) is sufficient for ~5 family users.

**Rationale**:
- Magic Link emails are the only emails sent (no marketing, no notifications)
- Typical usage: 1-2 logins per user per week = ~40-80 emails/month
- Even with retries and testing, well under 3,000/month
- Daily limit of 100 is more than enough for any realistic scenario

**Free Tier Details**:
| Limit | Value | Family Finance Usage |
|-------|-------|---------------------|
| Monthly emails | 3,000 | ~100 (estimated) |
| Daily emails | 100 | ~10 (estimated) |
| Domains | Unlimited | 1 needed |
| API keys | Unlimited | 1 needed |

**Edge Cases**:
- **Rate limit hit**: User sees "Check your email" but nothing arrives. Retry later.
- **Monthly limit hit**: Same behavior. Resets on billing cycle.
- **Resend outage**: Same behavior. Service usually recovers quickly.

**Monitoring**:
- Resend Dashboard shows usage statistics
- No automated alerting in free tier
- Manual check recommended monthly

**Alternatives Considered**:
- **Paid tier**: Rejected (unnecessary for family scale)
- **Multiple providers**: Rejected (adds complexity, free tier is sufficient)

---

### 7. Email Deliverability Considerations

**Task**: Research factors affecting email deliverability with Resend.

**Decision**: Proper domain verification (SPF, DKIM) ensures good deliverability.

**Rationale**:
- Resend has good sender reputation
- Custom domain with proper DNS records improves deliverability
- Magic Link emails are transactional (not marketing) - higher delivery rates
- Low volume means no risk of being flagged as spam

**Deliverability Factors**:
1. **SPF Record**: Authorizes Resend servers ✅ (configured in DNS)
2. **DKIM Record**: Cryptographic verification ✅ (configured in DNS)
3. **DMARC Record**: Policy for failed auth (optional but recommended)
4. **Sender Reputation**: Resend maintains good reputation ✅
5. **Email Content**: Supabase default templates are clean ✅
6. **Volume**: Low volume = no spam flags ✅

**Troubleshooting Non-Delivery**:
1. Check Resend Dashboard for delivery status
2. Verify DNS records are correct
3. Check recipient's spam folder
4. Verify sender email matches verified domain
5. Check Resend service status

**Alternatives Considered**:
- **Custom email templates**: Out of scope, Supabase defaults work fine
- **Email warm-up**: Not needed for low volume transactional emails

---

## Summary of Key Decisions

1. **SMTP Provider**: Resend via SMTP (not API) - no code changes needed
2. **Configuration Location**: Supabase Dashboard only - secure, no repo secrets
3. **DNS Records**: SPF + DKIM required, DMARC recommended
4. **API Key**: "Sending access" permission, domain-restricted
5. **Local Development**: Unchanged - continues using Inbucket
6. **Free Tier**: Sufficient for family use (~5 users)
7. **Deliverability**: Ensured by proper domain verification

## Dependencies to Verify

- [x] Resend free tier includes SMTP access ✅
- [x] Supabase Dashboard supports custom SMTP ✅
- [x] Resend supports custom domains ✅
- [x] Local Inbucket configuration unchanged ✅

## Implementation Checklist

### Pre-Implementation (Administrator Tasks)
- [ ] Create Resend account at resend.com
- [ ] Add and verify `financas.fflo.me` domain
- [ ] Configure DNS records (SPF, DKIM)
- [ ] Wait for domain verification
- [ ] Create "Sending access" API key

### Configuration (Supabase Dashboard)
- [ ] Navigate to Project Settings → Authentication
- [ ] Enable Custom SMTP
- [ ] Enter Resend SMTP credentials
- [ ] Set sender email to `noreply@financas.fflo.me`
- [ ] Save configuration

### Verification
- [ ] Test Magic Link in production
- [ ] Verify email arrives in real inbox
- [ ] Verify sender shows custom domain
- [ ] Verify authentication completes successfully
- [ ] Verify local development still uses Inbucket

